# Just Chat - アプリケーション仕様

## 概要

Just ChatはシンプルなWebベースのリアルタイムチャットアプリケーションです。アカウント登録不要で、名前を入力するだけですぐにチャットに参加できます。単一のチャットルームで複数人が同時にチャットを楽しめます。

## 基本機能

### チャットルーム
- WebSocketによるリアルタイム通信
- メッセージの永続化
- セッション管理
- 名前入力によるチャット参加（アカウント登録不要）

### チャットルーム（追加）
- チャット履歴の閲覧

### 複数人対応
- 単一のチャットルームで複数人同時参加

### 通知
- システムメッセージ自動送信（入室・退室通知）

### ユーザー機能
- 接続中ユーザーの表示

## 技術スタック

### フロントエンド
- Next.js
- TypeScript
- WebSocket Client

### バックエンド
- express.js
- TypeScript
- WebSocket Server

### データベース
- PostgreSQL
- Prisma ORM

### インフラ
- Docker
- Docker Compose

### 開発環境
- miseによるツールチェイン管理

## システムアーキテクチャ

### コンテナ構成
```
┌─────────────┐
│  Frontend   │ (Next.js)
│  Container  │
└──────┬──────┘
       │
       ↓
┌──────┬──────┐
│  Backend    │ (Express.js)
│  Container  │
└──────┬──────┘
       │
       ↓
┌──────┬──────┐
│  Database   │ (PostgreSQL)
│  Container  │
└─────────────┘
```

### 通信プロトコル
- HTTP/HTTPS: ページ読み込み、初期データ取得
- WebSocket: リアルタイムメッセージ送受信

## データモデル

### User
- id: UUID
- name: String
- socketId: String（WebSocket接続ID、接続中のみ）
- isOnline: Boolean（接続状態）
- lastActiveAt: DateTime（最終アクティブ日時）
- createdAt: DateTime
- updatedAt: DateTime

### Message
- id: UUID
- userId: UUID（外部キー: User.id、システムメッセージの場合はnull）
- userName: String（送信時のユーザー名、スナップショット）
- content: String
- type: String（"user" | "system"）
- createdAt: DateTime

### システムメッセージ種類

システムメッセージは以下のイベントで自動生成されます。

- 入室通知: 「〇〇さんが参加しました」
- 退室通知: 「〇〇さんが退出しました」

システムメッセージの特徴:
- typeフィールドが"system"
- userIdはnull
- DBに永続化され、チャット履歴として残る
- UIでは通常メッセージと区別して表示（グレー表示、中央寄せなど）

## ユーザーフロー

### 1. チャット参加
1. ユーザーがサイトにアクセス
2. 名前入力画面を表示
3. 名前を送信してバックエンドに登録
4. WebSocket接続を確立
5. システムメッセージ「〇〇さんが参加しました」を全ユーザーに配信
6. チャット画面へ遷移

### 2. メッセージ送信
1. ユーザーがメッセージを入力
2. 送信ボタンをクリック
3. メッセージをバックエンドに送信
4. メッセージがDBに保存され、全接続ユーザーに配信
5. 画面にメッセージが表示

### 3. 切断処理
1. ブラウザを閉じる、または通信が切断
2. WebSocket接続が終了
3. ユーザーのisOnlineをfalseに更新
4. システムメッセージ「〇〇さんが退出しました」を全ユーザーに配信

## セキュリティ考慮事項

- XSS対策: メッセージのサニタイズ処理
- メッセージ長制限: 過度に長いメッセージの制限
- 接続制限: 同一IPからの多重接続制限
- 悪意ある入力: 特殊文字のエスケープ処理

## 今後の拡張性

- ユーザーアバターの設定機能
- メッセージの編集・削除機能
- ファイル共有機能
- プライベートメッセージ機能
- 既読未読機能
